<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¤ªç©ºç«™ä¿è¡›æˆ°</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0a0a2a;
            cursor: none;
        }
        
        #moon {
            position: fixed;
            width: 200px;
            height: 200px;
            pointer-events: none;
            transition: transform 0.1s ease;
            z-index: 1000;
            background-image: url('./image/station1.png');
            background-size: contain;
            background-repeat: no-repeat;
        }

        .bullet {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            pointer-events: none;
            z-index: 95;
            box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #0ff;
        }

        .space-monster {
            position: fixed;
            font-size: 40px;
            z-index: 95;
            transition: transform 0.3s ease;
            animation: monsterFloat 3s infinite ease-in-out;
        }

        .health-bar {
            position: fixed;
            height: 20px;
            background: #333;
            border: 2px solid #fff;
            z-index: 1000;
        }

        .health-bar-fill {
            height: 100%;
            background: #f00;
            transition: width 0.3s ease;
        }

        .player-health {
            top: 20px;
            left: 20px;
            width: 200px;
        }

        .monster-health {
            width: 50px;
            height: 5px;
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .score-display {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 32px;
            color: #fff;
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
            z-index: 1000;
            font-weight: bold;
        }

        .game-screen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
            z-index: 2000;
            border: 2px solid #4fc3f7;
            box-shadow: 0 0 20px #4fc3f7;
        }

        .controls-info {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }

        .controls-info h2 {
            color: #4fc3f7;
            margin-bottom: 15px;
        }

        .skill-descriptions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .skill-item {
            padding: 15px;
            background: rgba(79, 195, 247, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(79, 195, 247, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .skill-icon {
            font-size: 24px;
            margin-bottom: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(79, 195, 247, 0.2);
            border-radius: 50%;
            animation: iconPulse 2s infinite;
        }

        .spread-shot {
            animation: rotate 2s linear infinite;
        }

        @keyframes iconPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .skill-detail {
            font-size: 14px;
            color: #aaa;
        }

        .music-control {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(79, 195, 247, 0.3);
        }

        .music-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }

        .music-button {
            padding: 10px 30px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        .music-button:hover {
            transform: scale(1.1);
            background: #45a049;
        }

        @keyframes monsterFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        #earth {
            position: fixed;
            font-size: 150px;
            left: 50px;
            bottom: 50px;
            z-index: 90;
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .star {
            position: fixed;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            pointer-events: none;
            animation: twinkle 1.5s infinite ease-in-out;
        }

        @keyframes twinkle {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        /* ä¸åŒé¡è‰²çš„æ˜Ÿæ˜Ÿ */
        .star-white { background-color: #fff; box-shadow: 0 0 10px #fff; }
        .star-blue { background-color: #4fc3f7; box-shadow: 0 0 10px #4fc3f7; }
        .star-purple { background-color: #e040fb; box-shadow: 0 0 10px #e040fb; }
        .star-yellow { background-color: #ffeb3b; box-shadow: 0 0 10px #ffeb3b; }
        .star-pink { background-color: #ff4081; box-shadow: 0 0 10px #ff4081; }

        .cooldown-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #fff;
            font-size: 16px;
            text-shadow: 0 0 10px #00ff00;
            z-index: 1000;
        }

        .shield {
            position: fixed;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 3px solid rgba(0, 255, 255, 0.5);
            pointer-events: none;
            z-index: 999;
            animation: shieldPulse 1.5s infinite;
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.3),
                inset 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .special-bullet {
            background: #ff00ff !important;
            box-shadow: 0 0 10px #ff00ff !important;
        }

        .homing-missile {
            width: 12px !important;
            height: 12px !important;
            background: #ff4081 !important;
            box-shadow: 0 0 15px #ff4081 !important;
            border-radius: 50% !important;
            animation: missilePulse 0.5s infinite;
        }

        @keyframes missilePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .laser-beam {
            position: fixed;
            width: 1000px;
            height: 6px;
            background: linear-gradient(90deg, 
                rgba(255,0,0,0) 0%,
                rgba(255,0,0,0.8) 20%,
                rgba(255,255,255,1) 50%,
                rgba(255,0,0,0.8) 80%,
                rgba(255,0,0,0) 100%
            );
            transform-origin: left center;
            z-index: 1000;
            animation: laserPulse 0.1s infinite;
        }

        @keyframes laserPulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        .bullet-impact {
            position: fixed;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(0,255,255,0.8) 0%, rgba(0,255,255,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            animation: impact 0.3s ease-out forwards;
        }

        @keyframes impact {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .spread-bullet {
            background: #ff00ff !important;
            box-shadow: 0 0 10px #ff00ff !important;
        }

        .super-missile {
            position: fixed;
            width: 20px;
            height: 20px;
            background: #ff4081;
            border-radius: 50%;
            box-shadow: 
                0 0 20px #ff4081,
                0 0 40px #ff4081;
            z-index: 1000;
            pointer-events: none;
        }

        .piercing-beam {
            position: fixed;
            width: 30px;
            height: 10px;
            background: linear-gradient(90deg, 
                rgba(0,255,255,0.8) 0%,
                rgba(0,255,255,1) 50%,
                rgba(0,255,255,0.8) 100%
            );
            border-radius: 5px;
            box-shadow: 0 0 20px #00ffff;
            z-index: 1000;
            pointer-events: none;
        }

        .explosion {
            position: fixed;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, 
                rgba(255,64,129,1) 0%,
                rgba(255,64,129,0.8) 30%,
                rgba(255,64,129,0) 70%
            );
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: explode 0.5s ease-out forwards;
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes explode {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        .power-bullet {
            position: fixed;
            width: 18px;
            height: 18px;
            background: #ff69b4;
            border-radius: 50%;
            box-shadow: 
                0 0 20px #ff69b4,
                0 0 40px #ff69b4;
            z-index: 1000;
            pointer-events: none;
            opacity: 0.8;
        }

        .super-bullet {
            position: fixed;
            width: 25px;
            height: 25px;
            background: #ff1493;
            border-radius: 50%;
            box-shadow: 
                0 0 30px #ff1493,
                0 0 50px #ff1493;
            z-index: 1000;
            pointer-events: none;
            opacity: 0.8;
        }

        .bullet-explosion {
            position: fixed;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, 
                rgba(255,64,129,1) 0%,
                rgba(255,64,129,0.5) 50%,
                rgba(255,64,129,0) 100%
            );
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: bulletExplode 0.3s ease-out forwards;
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes bulletExplode {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        /* æ·»åŠ ç™¼å…‰è»Œè·¡æ•ˆæœ */
        .power-bullet::after,
        .super-bullet::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: inherit;
            border-radius: 50%;
            filter: blur(5px);
            transform: translate(-50%, -50%);
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div id="earth">ğŸŒ</div>
    <div id="moon"></div>

    <script>
        // éŸ³æ¨‚æ§åˆ¶
        let bgMusic = new Audio('./music/åœ¨å¤ªç©ºæ‰“æ¶.mp3');
        bgMusic.loop = true; // å¾ªç’°æ’­æ”¾
        let isMusicEnabled = false;

        // éŠæˆ²ç‹€æ…‹
        const gameState = {
            score: 0,
            maxScore: 20,
            playerHealth: 100,
            isPlaying: false,
            gameStarted: false
        };

        // æŠ€èƒ½ç³»çµ±è¨­ç½®
        const cooldowns = {
            '1': 5000,   // æ•£å°„å½ˆå†·å»5ç§’
            '2': 8000,   // è¿½è¹¤å½ˆå†·å»8ç§’
            '3': 12000   // é›·å°„å…‰æŸå†·å»12ç§’
        };

        const lastUsed = {
            '1': 0,
            '2': 0,
            '3': 0
        };

        // åˆå§‹åŒ–éŠæˆ²
        function init() {
            createStars(); // å‰µå»ºæ˜ŸèƒŒæ™¯
            showStartScreen();
            setupGameControls();
        }

        // é¡¯ç¤ºé–‹å§‹ç•«é¢
        function showStartScreen() {
            const startScreen = document.createElement('div');
            startScreen.className = 'game-screen';
            startScreen.innerHTML = `
                <h1>å¤ªç©ºç«™ä¿è¡›æˆ°</h1>
                <p>æ“Šæ•—å¤–æ˜Ÿæ€ªç‰©ï¼Œä¿è­·å¤ªç©ºç«™ï¼</p>
                <p>ç›®æ¨™åˆ†æ•¸ï¼š${gameState.maxScore}åˆ†</p>
                <div class="controls-info">
                    <h2>æŠ€èƒ½èªªæ˜</h2>
                    <div class="skill-descriptions">
                        <div class="skill-item">
                            <div class="skill-icon spread-shot">ğŸ”„</div>
                            <p>æŒ‰1ï¼šç’°å½¢æ•£å°„</p>
                            <p class="skill-detail">ç™¼å°„8ç™¼ç’°å½¢å­å½ˆ (å†·å»5ç§’)</p>
                        </div>
                        <div class="skill-item">
                            <div class="skill-icon">ğŸ¯</div>
                            <p>æŒ‰2ï¼šå¼·åŠ›å…‰çƒ</p>
                            <p class="skill-detail">ç™¼å°„é«˜å‚·å®³å…‰çƒ (å†·å»8ç§’)</p>
                        </div>
                        <div class="skill-item">
                            <div class="skill-icon">ğŸŒŸ</div>
                            <p>æŒ‰3ï¼šè¶…ç´šå…‰çƒ</p>
                            <p class="skill-detail">ç™¼å°„è¶…å¤§å¨åŠ›å…‰çƒ (å†·å»12ç§’)</p>
                        </div>
                    </div>
                </div>
                <div class="music-control">
                    <p>æ˜¯å¦è¦æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ï¼Ÿ</p>
                    <div class="music-buttons">
                        <button class="music-button" onclick="handleMusicChoice(true)">æ˜¯</button>
                        <button class="music-button" onclick="handleMusicChoice(false)">å¦</button>
                    </div>
                    <p style="margin-top: 20px; font-size: 14px;">æç¤ºï¼šéŠæˆ²ä¸­æŒ‰å³éµå¯ä»¥é–‹é—œéŸ³æ¨‚</p>
                </div>
            `;
            document.body.appendChild(startScreen);
        }

        // è™•ç†éŸ³æ¨‚é¸æ“‡
        function handleMusicChoice(choice) {
            isMusicEnabled = choice;
            if (choice) {
                bgMusic.play();
            }
            startGame();
        }

        // é–‹å§‹éŠæˆ²
        function startGame() {
            document.querySelector('.game-screen').remove();
            gameState.isPlaying = true;
            gameState.gameStarted = true;
            gameState.score = 0;
            gameState.playerHealth = 100;
            
            createHealthBars();
            createScoreDisplay();
            startMonsterSpawning();
            gameLoop();
        }

        // å‰µå»ºè¡€æ¢
        function createHealthBars() {
            const playerHealth = document.createElement('div');
            playerHealth.className = 'health-bar player-health';
            playerHealth.innerHTML = '<div class="health-bar-fill" style="width: 100%"></div>';
            document.body.appendChild(playerHealth);
        }

        // å‰µå»ºåˆ†æ•¸é¡¯ç¤º
        function createScoreDisplay() {
            const scoreDisplay = document.createElement('div');
            scoreDisplay.className = 'score-display';
            scoreDisplay.textContent = `åˆ†æ•¸: ${gameState.score}`;
            document.body.appendChild(scoreDisplay);
        }

        // è¨­ç½®æ»‘é¼ ç§»å‹•
        function setupGameControls() {
            const moon = document.getElementById('moon');
            
            // æ»‘é¼ ç§»å‹•æ§åˆ¶å¤ªç©ºç«™
            document.addEventListener('mousemove', (e) => {
                moon.style.left = (e.clientX - moon.offsetWidth / 2) + 'px';
                moon.style.top = (e.clientY - moon.offsetHeight / 2) + 'px';
            });

            // å³éµé»æ“Šæ§åˆ¶éŸ³æ¨‚
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (isMusicEnabled) {
                    if (bgMusic.paused) {
                        bgMusic.play();
                    } else {
                        bgMusic.pause();
                    }
                }
            });

            // å·¦éµé»æ“Šç™¼å°„å­å½ˆ
            document.addEventListener('click', (e) => {
                if (gameState.isPlaying) {
                    shootBullet(e.clientX, e.clientY);
                }
            });

            // æŠ€èƒ½æŒ‰éµæ§åˆ¶
            document.addEventListener('keydown', (e) => {
                if (!gameState.isPlaying) return;
                
                const now = Date.now();
                switch(e.key) {
                    case '1':
                        if (now - lastUsed['1'] >= cooldowns['1']) {
                            activateShield();
                            lastUsed['1'] = now;
                        }
                        break;
                    case '2':
                        if (now - lastUsed['2'] >= cooldowns['2']) {
                            shootPowerBullet();
                            lastUsed['2'] = now;
                        }
                        break;
                    case '3':
                        if (now - lastUsed['3'] >= cooldowns['3']) {
                            shootSuperBullet();
                            lastUsed['3'] = now;
                        }
                        break;
                }
            });
        }

        // ç™¼å°„å­å½ˆ
        function shootBullet(targetX, targetY) {
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            
            const moon = document.getElementById('moon');
            const moonRect = moon.getBoundingClientRect();
            const startX = moonRect.left + moonRect.width/2;
            const startY = moonRect.top + moonRect.height/2;
            
            bullet.style.left = startX + 'px';
            bullet.style.top = startY + 'px';
            document.body.appendChild(bullet);

            const angle = Math.atan2(targetY - startY, targetX - startX);
            const speed = 10;
            const vx = Math.cos(angle) * speed;
            const vy = Math.sin(angle) * speed;

            const bulletInterval = setInterval(() => {
                const currentX = parseFloat(bullet.style.left);
                const currentY = parseFloat(bullet.style.top);
                
                bullet.style.left = (currentX + vx) + 'px';
                bullet.style.top = (currentY + vy) + 'px';

                // æª¢æŸ¥ç¢°æ’
                checkBulletCollisions(bullet);

                // æª¢æŸ¥æ˜¯å¦è¶…å‡ºè¢å¹•
                if (currentX < 0 || currentX > window.innerWidth || 
                    currentY < 0 || currentY > window.innerHeight) {
                    clearInterval(bulletInterval);
                    bullet.remove();
                }
            }, 16);
        }

        // ç”Ÿæˆæ€ªç‰©
        function startMonsterSpawning() {
            // åˆå§‹ç”Ÿæˆæ›´å¤šæ€ªç‰©
            for(let i = 0; i < 8; i++) { // æ”¹ç‚º 8 åˆå§‹æ€ªç‰©
                createMonster();
            }

            // æ¯éš”ä¸€æ®µæ™‚é–“æª¢æŸ¥ä¸¦ç¶­æŒæ€ªç‰©æ•¸é‡
            const spawnInterval = setInterval(() => {
                if (!gameState.isPlaying) {
                    clearInterval(spawnInterval);
                    return;
                }

                // ç²å–ç•¶å‰æ€ªç‰©æ•¸é‡
                const currentMonsters = document.querySelectorAll('.space-monster').length;
                
                // å¦‚æœæ€ªç‰©æ•¸é‡å°‘æ–¼8å€‹ï¼Œå‰‡ç”Ÿæˆæ–°çš„æ€ªç‰©
                const targetMonsterCount = 8; // ç¶­æŒ 8 å€‹æ€ªç‰©
                if (currentMonsters < targetMonsterCount) {
                    // ä¸€æ¬¡æ€§è£œå……åˆ°ç›®æ¨™æ•¸é‡
                    for (let i = currentMonsters; i < targetMonsterCount; i++) {
                        createMonster();
                    }
                }
            }, 800); // ç¸®çŸ­æª¢æŸ¥é–“éš”ç‚º 800ms
        }

        // å‰µå»ºæ€ªç‰©
        function createMonster() {
            const monster = document.createElement('div');
            monster.className = 'space-monster';
            monster.textContent = 'ğŸ‘¾';
            monster.dataset.health = 50;

            // æ·»åŠ æ€ªç‰©è¡€æ¢
            const healthBar = document.createElement('div');
            healthBar.className = 'health-bar monster-health';
            healthBar.innerHTML = '<div class="health-bar-fill" style="width: 100%"></div>';
            monster.appendChild(healthBar);

            // åªå¾å³å´ç”Ÿæˆ
            const x = window.innerWidth;
            const y = Math.random() * (window.innerHeight - 100); // é¿å…å¤ªé è¿‘é‚Šç·£
            
            monster.style.left = x + 'px';
            monster.style.top = y + 'px';
            document.body.appendChild(monster);

            moveMonster(monster);
        }

        // æ€ªç‰©ç§»å‹•
        function moveMonster(monster) {
            let moveLeft = true; // æ§åˆ¶å·¦å³ç§»å‹•
            const baseSpeed = 2; // åŸºç¤ç§»å‹•é€Ÿåº¦

            const moveInterval = setInterval(() => {
                if (!gameState.isPlaying) {
                    clearInterval(moveInterval);
                    return;
                }

                const monsterRect = monster.getBoundingClientRect();
                
                // åŸºæœ¬ç§»å‹•
                if (moveLeft) {
                    monster.style.left = (monsterRect.left - baseSpeed) + 'px';
                    if (monsterRect.left <= 0) {
                        moveLeft = false;
                    }
                } else {
                    monster.style.left = (monsterRect.left + baseSpeed) + 'px';
                    if (monsterRect.right >= window.innerWidth) {
                        moveLeft = true;
                    }
                }

                // è¼•å¾®çš„ä¸Šä¸‹æµ®å‹•ï¼ˆä¿æŒåŸæœ‰çš„æµ®å‹•å‹•ç•«ï¼‰
                if (Math.random() < 0.02) { // 2% çš„æ”»æ“Šæ©Ÿç‡
                    shootMonsterBullet(monster);
                }
            }, 50);

            monster.addEventListener('remove', () => clearInterval(moveInterval));
        }

        // æ€ªç‰©å°„æ“Š
        function shootMonsterBullet(monster) {
            const monsterRect = monster.getBoundingClientRect();
            const moonRect = document.getElementById('moon').getBoundingClientRect();
            
            const startX = monsterRect.left + monsterRect.width/2;
            const startY = monsterRect.top + monsterRect.height/2;
            const targetX = moonRect.left + moonRect.width/2;
            const targetY = moonRect.top + moonRect.height/2;
            
            const bullet = document.createElement('div');
            bullet.className = 'bullet monster-bullet';
            bullet.style.left = startX + 'px';
            bullet.style.top = startY + 'px';
            document.body.appendChild(bullet);

            const angle = Math.atan2(targetY - startY, targetX - startX);
            const speed = 5;
            const vx = Math.cos(angle) * speed;
            const vy = Math.sin(angle) * speed;

            const bulletInterval = setInterval(() => {
                const currentX = parseFloat(bullet.style.left);
                const currentY = parseFloat(bullet.style.top);
                
                bullet.style.left = (currentX + vx) + 'px';
                bullet.style.top = (currentY + vy) + 'px';

                // æª¢æŸ¥æ˜¯å¦æ“Šä¸­ç©å®¶
                if (checkCollision(bullet, document.getElementById('moon'))) {
                    updateHealth('player', 2);
                    clearInterval(bulletInterval);
                    bullet.remove();
                }

                // æª¢æŸ¥æ˜¯å¦è¶…å‡ºè¢å¹•
                if (currentX < 0 || currentX > window.innerWidth || 
                    currentY < 0 || currentY > window.innerHeight) {
                    clearInterval(bulletInterval);
                    bullet.remove();
                }
            }, 16);
        }

        // ä¿®æ”¹å­å½ˆç¢°æ’æª¢æ¸¬
        function checkBulletCollisions(bullet) {
            const moon = document.getElementById('moon');
            const moonRect = moon.getBoundingClientRect();
            const shield = document.querySelector('.shield');

            // å¦‚æœæ˜¯æ€ªç‰©çš„å­å½ˆ
            if (bullet.classList.contains('monster-bullet')) {
                // æª¢æŸ¥æ˜¯å¦æœ‰è­·ç›¾
                if (shield && checkCollision(bullet, shield)) {
                    // å­å½ˆç¢°åˆ°è­·ç›¾å°±ç›´æ¥æ¶ˆå¤±
                    bullet.remove();
                    
                    // å¯ä»¥æ·»åŠ ä¸€å€‹è¦–è¦ºæ•ˆæœä¾†é¡¯ç¤ºå­å½ˆè¢«æ“‹ä½
                    const impact = document.createElement('div');
                    impact.className = 'bullet-impact';
                    impact.style.left = bullet.style.left;
                    impact.style.top = bullet.style.top;
                    document.body.appendChild(impact);
                    
                    // çŸ­æš«å¾Œç§»é™¤è¦–è¦ºæ•ˆæœ
                    setTimeout(() => impact.remove(), 300);
                    return;
                }
                
                // å¦‚æœæ²’æœ‰è­·ç›¾æˆ–å­å½ˆæ²’ç¢°åˆ°è­·ç›¾ï¼Œæª¢æŸ¥æ˜¯å¦ç¢°åˆ°å¤ªç©ºç«™
                if (checkCollision(bullet, moon)) {
                    updateHealth('player', 2);
                    bullet.remove();
                }
            } 
            // å¦‚æœæ˜¯ç©å®¶çš„å­å½ˆ
            else {
                document.querySelectorAll('.space-monster').forEach(monster => {
                    if (checkCollision(bullet, monster)) {
                        handleMonsterHit(monster, 3);
                        bullet.remove();
                    }
                });
            }
        }

        // è™•ç†æ€ªç‰©å—å‚·çš„å‡½æ•¸
        function handleMonsterHit(monster, damage) {
            const monsterHealth = parseInt(monster.dataset.health) - damage;
            monster.dataset.health = monsterHealth;
            
            // æ›´æ–°æ€ªç‰©è¡€æ¢
            const healthFill = monster.querySelector('.health-bar-fill');
            healthFill.style.width = `${(monsterHealth / 50) * 100}%`;

            if (monsterHealth <= 0) {
                monster.remove();
                updateScore(5);
            }
        }

        // ç¢°æ’æª¢æ¸¬
        function checkCollision(elem1, elem2) {
            const rect1 = elem1.getBoundingClientRect();
            const rect2 = elem2.getBoundingClientRect();
            
            return !(rect1.right < rect2.left || 
                    rect1.left > rect2.right || 
                    rect1.bottom < rect2.top || 
                    rect1.top > rect2.bottom);
        }

        // æ–°åˆ†æ•¸
        function updateScore(points) {
            gameState.score += points;
            document.querySelector('.score-display').textContent = `åˆ†æ•¸: ${gameState.score}`;
            
            if (gameState.score >= gameState.maxScore) {
                endGame('win');
            }
        }

        // æ›´æ–°è¡€é‡
        function updateHealth(target, damage) {
            if (target === 'player') {
                gameState.playerHealth -= damage;
                document.querySelector('.player-health .health-bar-fill').style.width = 
                    `${gameState.playerHealth}%`;
                
                if (gameState.playerHealth <= 0) {
                    endGame('lose');
                }
            }
        }

        // çµæŸéŠæˆ²
        function endGame(result) {
            gameState.isPlaying = false;
            bgMusic.pause(); // åœæ­¢éŸ³æ¨‚
            
            // æ¸…é™¤æ‰€æœ‰æ€ªç‰©å’Œå­å½ˆ
            document.querySelectorAll('.space-monster, .bullet').forEach(elem => elem.remove());
            
            // é¡¯ç¤ºçµæŸç•«é¢
            const endScreen = document.createElement('div');
            endScreen.className = 'game-screen';
            endScreen.innerHTML = `
                <h1>${result === 'win' ? 'å‹åˆ©ï¼' : 'å¤±æ•—ï¼'}</h1>
                <p>æœ€çµ‚å¾—åˆ†ï¼š${gameState.score}</p>
                <button class="game-button" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
            `;
            document.body.appendChild(endScreen);
        }

        // é‡æ–°é–‹å§‹éŠæˆ²
        function restartGame() {
            // æ¸…é™¤æ‰€æœ‰ç¾æœ‰çš„éŠæˆ²å…ƒç´ 
            document.querySelectorAll('.space-monster, .bullet, .shield').forEach(elem => elem.remove());
            document.querySelector('.game-screen')?.remove();
            document.querySelector('.player-health')?.remove();
            document.querySelector('.score-display')?.remove();

            // é‡ç½®éŠæˆ²æ…‹
            gameState.score = 0;
            gameState.playerHealth = 100;
            gameState.isPlaying = true;
            
            // å¦‚æœä¹‹å‰é–‹å•Ÿäº†éŸ³æ¨‚ï¼Œé‡æ–°é–‹å§‹æ’­æ”¾
            if (isMusicEnabled && bgMusic.paused) {
                bgMusic.currentTime = 0; // å¾é ­é–‹å§‹æ’­æ”¾
                bgMusic.play();
            }
            
            // é‡æ–°åˆå§‹åŒ–éŠæˆ²å…ƒç´ 
            createHealthBars();
            createScoreDisplay();
            startMonsterSpawning();
            setupGameControls();
        }

        // æŠ€èƒ½1ï¼šè­·ç›¾
        function activateShield() {
            const moon = document.getElementById('moon');
            const shield = document.createElement('div');
            shield.className = 'shield';
            document.body.appendChild(shield);

            // è®“è­·ç›¾è·Ÿéš¨å¤ªç©ºç«™
            const updateShieldPosition = () => {
                const moonRect = moon.getBoundingClientRect();
                shield.style.left = (moonRect.left - 25) + 'px';
                shield.style.top = (moonRect.top - 25) + 'px';
            };

            const shieldInterval = setInterval(updateShieldPosition, 16);
            updateShieldPosition();

            // 20ç§’å¾Œç§»é™¤è­·ç›¾
            setTimeout(() => {
                clearInterval(shieldInterval);
                shield.remove();
            }, 20000);
        }

        // æŠ€èƒ½2ï¼šå¼·åŠ›å…‰çƒ
        function shootPowerBullet() {
            const moon = document.getElementById('moon');
            const moonRect = moon.getBoundingClientRect();
            const bullet = document.createElement('div');
            bullet.className = 'power-bullet';
            
            const startX = moonRect.left + moonRect.width/2;
            const startY = moonRect.top + moonRect.height/2;
            bullet.style.left = startX + 'px';
            bullet.style.top = startY + 'px';
            document.body.appendChild(bullet);

            const angle = Math.atan2(
                event.clientY - startY,
                event.clientX - startX
            );

            const speed = 8;
            const vx = Math.cos(angle) * speed;
            const vy = Math.sin(angle) * speed;

            const moveInterval = setInterval(() => {
                const currentX = parseFloat(bullet.style.left);
                const currentY = parseFloat(bullet.style.top);
                
                bullet.style.left = (currentX + vx) + 'px';
                bullet.style.top = (currentY + vy) + 'px';

                // æª¢æŸ¥ç¢°æ’
                document.querySelectorAll('.space-monster').forEach(monster => {
                    if (checkCollision(bullet, monster)) {
                        handleMonsterHit(monster, 15);
                        bullet.remove();
                        clearInterval(moveInterval);
                    }
                });

                if (currentX < 0 || currentX > window.innerWidth || 
                    currentY < 0 || currentY > window.innerHeight) {
                    clearInterval(moveInterval);
                    bullet.remove();
                }
            }, 16);
        }

        // æŠ€èƒ½3ï¼šè¶…ç´šå…‰çƒ
        function shootSuperBullet() {
            const moon = document.getElementById('moon');
            const moonRect = moon.getBoundingClientRect();
            const bullet = document.createElement('div');
            bullet.className = 'super-bullet';
            
            const startX = moonRect.left + moonRect.width/2;
            const startY = moonRect.top + moonRect.height/2;
            bullet.style.left = startX + 'px';
            bullet.style.top = startY + 'px';
            document.body.appendChild(bullet);

            const angle = Math.atan2(
                event.clientY - startY,
                event.clientX - startX
            );

            const speed = 10;
            const vx = Math.cos(angle) * speed;
            const vy = Math.sin(angle) * speed;

            const moveInterval = setInterval(() => {
                const currentX = parseFloat(bullet.style.left);
                const currentY = parseFloat(bullet.style.top);
                
                bullet.style.left = (currentX + vx) + 'px';
                bullet.style.top = (currentY + vy) + 'px';

                // æª¢æŸ¥ç¢°æ’
                document.querySelectorAll('.space-monster').forEach(monster => {
                    if (checkCollision(bullet, monster)) {
                        handleMonsterHit(monster, 20);
                        bullet.remove();
                        clearInterval(moveInterval);
                    }
                });

                if (currentX < 0 || currentX > window.innerWidth || 
                    currentY < 0 || currentY > window.innerHeight) {
                    clearInterval(moveInterval);
                    bullet.remove();
                }
            }, 16);
        }

        // å­å½ˆçˆ†ç‚¸æ•ˆæœ
        function createBulletExplosion(x, y) {
            const explosion = document.createElement('div');
            explosion.className = 'bullet-explosion';
            explosion.style.left = x + 'px';
            explosion.style.top = y + 'px';
            document.body.appendChild(explosion);
            setTimeout(() => explosion.remove(), 300);
        }

        // åˆå§‹åŒ–éŠæˆ²
        init();

        function createStars() {
            const colors = ['white', 'blue', 'purple', 'yellow', 'pink'];
            const starCount = 100;

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = `star star-${colors[Math.floor(Math.random() * colors.length)]}`;
                star.style.left = Math.random() * window.innerWidth + 'px';
                star.style.top = Math.random() * window.innerHeight + 'px';
                document.body.appendChild(star);
            }
        }

        // æ·»åŠ æŠ€èƒ½å†·å»æç¤º
        function createCooldownDisplay() {
            const display = document.createElement('div');
            display.className = 'cooldown-display';
            display.innerHTML = `
                <div class="skill-info">
                    <div>1: è­·ç›¾ (25ç§’)</div>
                    <div>2: è¿½è¹¤å½ˆ (5ç§’)</div>
                    <div>3: æ•£å°„å½ˆ (8ç§’)</div>
                </div>
            `;
            document.body.appendChild(display);
        }

        // ä¿®æ”¹æ€ªç‰©çš„ç¢°æ’æª¢æ¸¬
        function checkMonsterCollisions() {
            const moon = document.getElementById('moon');
            const moonRect = moon.getBoundingClientRect();
            const shield = document.querySelector('.shield');

            document.querySelectorAll('.space-monster').forEach(monster => {
                const monsterRect = monster.getBoundingClientRect();
                
                // å¦‚æœæœ‰è­·ç›¾ï¼Œæ€ªç‰©ç¢°åˆ°è­·ç›¾æœƒè¢«å½ˆé–‹ï¼Œä½†ä¸å—å‚·
                if (shield) {
                    const shieldRect = shield.getBoundingClientRect();
                    if (checkCollision(monster, shield)) {
                        // åªå½ˆé–‹æ€ªç‰©ï¼Œä¸é€ æˆå‚·å®³
                        const angle = Math.atan2(
                            monsterRect.top - moonRect.top,
                            monsterRect.left - moonRect.left
                        );
                        monster.style.left = (monsterRect.left + Math.cos(angle) * 50) + 'px';
                        monster.style.top = (monsterRect.top + Math.sin(angle) * 50) + 'px';
                    }
                }
                // å¦‚æœæ²’æœ‰è­·ç›¾ï¼Œæ€ªç‰©ç¢°åˆ°å¤ªç©ºç«™æœƒé€ æˆå‚·å®³
                else if (checkCollision(monster, moon)) {
                    updateHealth('player', 5);
                    // è®“æ€ªç‰©è¢«å½ˆé–‹
                    const angle = Math.atan2(
                        monsterRect.top - moonRect.top,
                        monsterRect.left - moonRect.left
                    );
                    monster.style.left = (monsterRect.left + Math.cos(angle) * 50) + 'px';
                    monster.style.top = (monsterRect.top + Math.sin(angle) * 50) + 'px';
                }
            });
        }

        // åœ¨éŠæˆ²ä¸»å¾ªç’°ä¸­èª¿ç”¨ç¢°æ’æª¢æ¸¬
        function gameLoop() {
            if (gameState.isPlaying) {
                checkMonsterCollisions();
                requestAnimationFrame(gameLoop);
            }
        }
    </script>
</body>
</html>
